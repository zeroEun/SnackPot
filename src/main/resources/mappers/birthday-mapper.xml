<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="birthdayMapper">

	<resultMap type="Birthday" id="bServiceResultSet">
		<id property="bservice_no" column="BSERVICE_NO"/>
		<result property="sending_time" column="SENDING_TIME"/>
		<result property="notification_msg" column="NOTIFICATION_MESSAGE"/>
		<result property="completion_msg" column="COMPLETION_MESSAGE"/>
		<result property="settlement_date" column="SETTLEMENT_DATE"/>
		<result property="bservice_status" column="BSERVICE_STATUS"/>
		<result property="com_code" column="COM_CODE"/>
	</resultMap>
	
	<resultMap type="CurStatus" id="curStsResultSet">
		<id property="curStatusNo" column="SCSTATUS_NO"></id>
		<result property="cempDept" column="CEMP_DEPT"></result>
		<result property="cempJob" column="CEMP_JOB"></result>
		<result property="cempName" column="CEMP_NAME"></result>
		<result property="cempPhone" column="CEMP_PHONE"></result>
		<result property="cempBirth" column="CEMP_BIRTH"></result>
		<result property="sendingMsgDate" column="SENDING_MESSAGE_DATE"></result>
		<result property="selectDate" column="SELECT_COMPLETE_DATE"></result>
	</resultMap>
	
	<resultMap type="SendingStatus" id="sendingStsResultSet">
		<id property="curStatusNo" column="SCSTATUS_NO"></id>
		<result property="cempSeq" column="CEMP_SEQ"></result>
		<result property="cempDept" column="CEMP_DEPT"></result>
		<result property="cempJob" column="CEMP_JOB"></result>
		<result property="cempName" column="CEMP_NAME"></result>
		<result property="cempPhone" column="CEMP_PHONE"></result>
		<result property="cempBirth" column="CEMP_BIRTH"></result>
		<result property="cempEmail" column="CEMP_EMAIL"></result>
		<result property="sendingMsgDate" column="SENDING_MESSAGE_DATE"></result>
		<result property="selectDate" column="SELECT_COMPLETE_DATE"></result>		
	</resultMap>
	
	<resultMap type="SendingList" id="sendListResultSet">
		<id property="sListNo" column="SLIST_NO"></id>
		<result property="cempDept" column="CEMP_DEPT"></result>
		<result property="cempJob" column="CEMP_JOB"></result>
		<result property="cempName" column="CEMP_NAME"></result>
		<result property="cempPhone" column="CEMP_PHONE"></result>
		<result property="cempBirth" column="CEMP_BIRTH"></result>
		<result property="sendMsgDate" column="SENDING_MESSAGE_DATE"></result>
		<result property="sListStatus" column="SLIST_STATUS"></result>
		<result property="glistNo" column="GLIST_NO"></result>
		<result property="cempSeq" column="CEMP_SEQ"></result>
	</resultMap>
	
	<resultMap type="SendList" id="sListResultSet">
		<id property="sListNo" column="SLIST_NO"></id>
		<result property="cempDept" column="CEMP_DEPT"></result>
		<result property="cempJob" column="CEMP_JOB"></result>
		<result property="cempName" column="CEMP_NAME"></result>
		<result property="cempPhone" column="CEMP_PHONE"></result>
		<result property="cempBirth" column="CEMP_BIRTH"></result>
		<result property="sendMsgDate" column="SENDING_MESSAGE_DATE"></result>
		<result property="sListStatus" column="SLIST_STATUS"></result>
		<result property="glistNo" column="GLIST_NO"></result>
		<result property="cempSeq" column="CEMP_SEQ"></result>
	</resultMap>
	
	<resultMap type="GiftList" id="giftListResultSet">
		<id property="giftNo" column="GIFT_NO"></id>
		<result property="giftBrand" column="GIFT_BRAND"></result>
		<result property="giftName" column="GIFT_NAME"></result>
		<result property="giftPrice" column="GIFT_PRICE"></result>
		<result property="changeName" column="CHANGE_NAME"></result>
	</resultMap>

	<select id="countEmp" resultType="_int">
		SELECT COUNT(*) FROM COMPANY_EMP
		WHERE COM_CODE = #{comCode}
		AND CEMP_STATUS='Y'
	</select>

	<insert id="subscribe" parameterType="Birthday">
		INSERT INTO BIRTHDAY_SERVICE VALUES
		<!-- ('1', #{per_amount}, #{sending_time}, #{notification_msg}, #{completion_msg}, SYSDATE, DEFAULT, #{com_code}) -->
		(BSERVICE_SEQ.NEXTVAL, #{per_amount}, #{sending_time}, #{notification_msg}, NULL, SYSDATE, DEFAULT, 'A')
	</insert>
	
	<select id="subscribeInfo" parameterType="String" resultMap="bServiceResultSet">
		SELECT * FROM BIRTHDAY_SERVICE WHERE COM_CODE = #{comCode} AND BSERVICE_STATUS='Y'
	</select>
	
	<update id="updateSubscribe" parameterType="Birthday">
		UPDATE BIRTHDAY_SERVICE SET
		PER_AMOUNT=#{per_amount}, SENDING_TIME=#{sending_time}, NOTIFICATION_MESSAGE=#{notification_msg}
		WHERE COM_CODE=#{com_code}
	</update>
	
	<select id="subscribeChk" parameterType="String" resultType="_int">
		SELECT COUNT(*) FROM BIRTHDAY_SERVICE WHERE COM_CODE = #{com_code} AND BSERVICE_STATUS='Y'
	</select>
	
	<!-- 구독회사용 -->
	<select id="selectsList" resultMap="sendingStsResultSet">
		SELECT 
		B.CEMP_SEQ, B.CEMP_DEPT, B.CEMP_JOB, B.CEMP_NAME, B.CEMP_PHONE, B.CEMP_BIRTH
		, A.SENDING_MESSAGE_DATE, A.SELECT_COMPLETE_DATE
		FROM SENDING_CURRENT_STATUS A
		JOIN COMPANY_EMP B ON A.CEMP_SEQ = B.CEMP_SEQ
		WHERE TO_CHAR(B.CEMP_BIRTH,'MM') = TO_CHAR(SYSDATE,'MM')
		AND B.CEMP_STATUS='Y'
		ORDER BY SENDING_MESSAGE_DATE
	</select>
	
	<!-- 발송 현황/발송 예정 리스트에서 선택 삭제 -->
	<delete id="deleteSendStatus" parameterType="_int">
		UPDATE COMPANY_EMP SET CEMP_STATUS = 'N'
		WHERE CEMP_SEQ = #{cempSeq}
	</delete>

	<!-- 발송 현황 - 선택 수정 시 가져올 객체 정보  -->
	<select id="selectEmpOne" parameterType="_int" resultMap="sendingStsResultSet">
		SELECT CEMP_DEPT, CEMP_JOB, CEMP_NAME, CEMP_PHONE, CEMP_EMAIL, CEMP_BIRTH FROM COMPANY_EMP
		WHERE CEMP_SEQ=#{cempSeq} AND CEMP_STATUS='Y'
	</select>
	
	<insert id="insertSendStatus" parameterType="SendingStatus">
		INSERT INTO COMPANY_EMP VALUES
		(COM_EMP_SEQ.NEXTVAL, #{cempName}, #{cempDept}, #{cempJob}, #{cempEmail}, #{cempPhone}, #{cempBirth}, 'A', TEST_SEQ1.NEXTVAL, 'Y')
	</insert>
	
	<update id="updateSendStatus" parameterType="SendingStatus">
		UPDATE COMPANY_EMP SET
		CEMP_NAME=#{cempName}, CEMP_DEPT=#{cempDept}, CEMP_JOB=#{cempJob}, 
		CEMP_EMAIL=#{cempEmail}, CEMP_PHONE=#{cempPhone}, CEMP_BIRTH=#{cempBirth} 
		WHERE CEMP_SEQ=#{cempSeq}
	</update>
	
	<select id="selectSendList" resultMap="sListResultSet">
		SELECT 
		B.CEMP_DEPT, B.CEMP_JOB, B.CEMP_NAME, B.CEMP_PHONE, B.CEMP_BIRTH
		, A.SENDING_MESSAGE_DATE, A.GLIST_NO
		FROM SENDING_LIST A
		JOIN COMPANY_EMP B ON A.CEMP_SEQ = B.CEMP_SEQ
		WHERE TO_CHAR(B.CEMP_BIRTH,'MM') = TO_CHAR(ADD_MONTHS(TRUNC(SYSDATE,'MM'),1),'MM')
		AND B.CEMP_STATUS='Y'
		AND A.SLIST_STATUS='Y'
		ORDER BY SENDING_MESSAGE_DATE
	</select>
	
	<!-- 본사용 -->
	<select id="selectList" resultMap="curStsResultSet">
		SELECT 
		B.CEMP_DEPT, B.CEMP_JOB, B.CEMP_NAME, B.CEMP_PHONE, B.CEMP_BIRTH
		, A.SENDING_MESSAGE_DATE, A.SELECT_COMPLETE_DATE
		FROM SENDING_CURRENT_STATUS A
		JOIN COMPANY_EMP B ON A.CEMP_SEQ = B.CEMP_SEQ
		WHERE TO_CHAR(B.CEMP_BIRTH,'MM') = TO_CHAR(SYSDATE,'MM')
		AND B.CEMP_STATUS='Y'
		ORDER BY SENDING_MESSAGE_DATE
	</select>
	
	<select id="selectSendingList" resultMap="sendListResultSet">
		SELECT 
		B.CEMP_DEPT, B.CEMP_JOB, B.CEMP_NAME, B.CEMP_PHONE, B.CEMP_BIRTH
		, A.SENDING_MESSAGE_DATE, A.GLIST_NO
		FROM SENDING_LIST A
		JOIN COMPANY_EMP B ON A.CEMP_SEQ = B.CEMP_SEQ
		WHERE TO_CHAR(B.CEMP_BIRTH,'MM') = TO_CHAR(ADD_MONTHS(TRUNC(SYSDATE,'MM'),1),'MM')
		AND B.CEMP_STATUS='Y'
		ORDER BY SENDING_MESSAGE_DATE
	</select>
	
	<select id="selectGiftList" resultMap="giftListResultSet">
		SELECT A.GIFT_NO, A.GIFT_BRAND, A.GIFT_NAME, A.GIFT_PRICE, B.CHANGE_NAME
		FROM BIRTHDAY_GIFT A
		JOIN GIFT_ATTACHMENT B ON A.GIFT_NO = B.GIFT_REF_NO
		WHERE GIFT_STATUS='Y'
	</select>
</mapper>
