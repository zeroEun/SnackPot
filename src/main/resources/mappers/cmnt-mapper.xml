<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
 <mapper namespace="cmntMapper">
	<resultMap type="Community" id="communityResultSet">
	 	<id property="communityNo" column="COMMUNITY_NO"/>
		<result property="content" column="CONTENT"/>
		<result property="views" column="VIEWS"/>
		<result property="recommend" column="RECOMMEND"/>
		<result property="n_recommend" column="N_RECOMMEND"/>
		<result property="writerDate" column="WRITER_DATE"/>
		<result property="status" column="STATUS"/>
		<result property="writer" column="WRITER"/>
		<result property="title" column="TITLE"/>
		<result property="comCode" column="COM_CODE" />
		<result property="changeName" column="CHANGE_NAME"/>
		<result property="originName" column="ORIGIN_NAME"/>		
	</resultMap>

	<resultMap type="ComtyAttachment" id="ComtyAttachmentResultSet">
	 	<id property="fileNo" column="FILE_NO"/>
		<result property="originName" column="ORIGIN_NAME"/>
		<result property="changeName" column="CHANGE_NAME"/>
		<result property="filePath" column="FILE_PATH"/>
		<result property="communityNo" column="COMMUNITY_NO"/>
	</resultMap> 	

	<resultMap type="Reply" id="ReplyResultSet">
	 	<id property="reNo" column="RE_NO"/>
		<result property="communityNo" column="COMMUNITY_NO"/>
		<result property="reGroup" column="RE_GROUP"/>
		<result property="reGroups" column="RE_GROUPS"/>
		<result property="reGroupDept" column="RE_GROUPDEPT"/>
		<result property="reWriter" column="RE_WRITER"/>
		<result property="reContent" column="RE_CONTENT"/>
		<result property="reDate" column="RE_DATE"/>
	</resultMap> 	
	
<select id="selectListCount" resultType="_int">
	SELECT COUNT(*)
	FROM COMMUNITY
	WHERE STATUS = 'Y'
    AND COM_CODE= #{comCode}
</select>


<select id="selectList" resultMap="communityResultSet">
	SELECT A.COMMUNITY_NO , A.CONTENT, A.VIEWS, A.RECOMMEND , A.N_RECOMMEND , A.WRITER_DATE , A.TITLE , A.COM_CODE,
       	   A.WRITER , B.CHANGE_NAME ,B.ORIGIN_NAME
	FROM COMMUNITY A 
	LEFT OUTER JOIN COMTY_ATTACHMENT B ON (A.COMMUNITY_NO = B.COMMUNITY_NO)
	WHERE A.STATUS='Y'
	ORDER BY A.COMMUNITY_NO DESC
</select>


<insert id="insertCommunity" parameterType="Community">
	INSERT INTO COMMUNITY
	VALUES (CMNT_SEQ.NEXTVAL , #{content} , 0 , 0 , 0 , SYSDATE , 'Y' , #{writer} , #{title} , #{comCode} )
</insert>

<select id="selectCmntNo" resultType="_int">
	SELECT MAX(COMMUNITY_NO)
	FROM COMMUNITY
	WHERE WRITER = #{memId}
</select>

<insert id="insertCommunityAttachment" parameterType="ComtyAttachment">
	INSERT INTO COMTY_ATTACHMENT
	VALUES (CMNTATT_SEQ.NEXTVAL , #{originName} , #{changeName} , #{filePath} , #{communityNo})
</insert>


<select id="selectDetailCmnt" parameterType="_int" resultMap="communityResultSet">
	SELECT A.COMMUNITY_NO , A.CONTENT, A.VIEWS, A.RECOMMEND , A.N_RECOMMEND , A.WRITER_DATE , A.TITLE , A.COM_CODE,
		 A.WRITER , B.CHANGE_NAME ,B.ORIGIN_NAME
	FROM COMMUNITY A
	LEFT OUTER JOIN COMTY_ATTACHMENT B ON (A.COMMUNITY_NO = B.COMMUNITY_NO)
	WHERE A.COMMUNITY_NO = #{cno}
	AND A.STATUS = 'Y'
</select>

<update id="updateCmnt" parameterType="Community">
	UPDATE COMMUNITY
	SET CONTENT=#{content} , TITLE=#{title} , WRITER_DATE=SYSDATE
	WHERE COMMUNITY_NO= #{communityNo}
</update>

<delete id="deleteCmntAttachment" parameterType="ComtyAttachment">
	DELETE FROM COMTY_ATTACHMENT
	WHERE COMMUNITY_NO =#{communityNo}
</delete>

<update id="updateAttachment" parameterType="ComtyAttachment">
	UPDATE COMTY_ATTACHMENT
	SET ORIGIN_NAME =#{originName}, CHANGE_NAME=#{changeName}
	WHERE COMMUNITY_NO =#{communityNo}
</update>

<update id="deleteCmnt" parameterType="Community">
	UPDATE COMMUNITY
	SET STATUS='N'
	WHERE COMMUNITY_NO =#{communityNo}
</update>

<update id="updateViews">
	UPDATE COMMUNITY SET VIEWS = VIEWS +1 
	WHERE COMMUNITY_NO = #{cno}
</update>

<update id="updateRecommend">
	UPDATE COMMUNITY SET RECOMMEND = RECOMMEND +1 
	WHERE COMMUNITY_NO = #{cno}
</update>

<update id="updateNrecommend">
	UPDATE COMMUNITY SET N_RECOMMEND = N_RECOMMEND +1 
	WHERE COMMUNITY_NO = #{cno}
</update>

<!-- 댓글 -->

<select id="selectReplyList" parameterType="_int" resultMap="ReplyResultSet">
	SELECT *
	FROM REPLY
	WHERE COMMUNITY_NO = #{cno}
	ORDER BY RE_GROUP ASC , RE_GROUPDEPT
</select>
</mapper>
